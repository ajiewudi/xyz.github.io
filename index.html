<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»™ç‰¹åˆ«çš„ä½ </title>
    <style>
        /* --- å…¨å±€è®¾ç½® --- */
        body, html {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            overflow: hidden; 
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        /* --- èƒŒæ™¯å›¾è®¾ç½® --- */
        body {
            /* è¿™é‡Œè®¾ç½®èƒŒæ™¯å›¾ï¼Œå åŠ ä¸€å±‚åŠé€æ˜ç™½è‰²è®©æ–‡å­—æ›´æ¸…æ™° */
            background: linear-gradient(rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.3)), 
                        url('images/bg.jpg') no-repeat center center fixed;
            background-size: cover; /* è®©å›¾ç‰‡é“ºæ»¡å±å¹• */
        }

        /* --- æ¼‚æµ®å›¾ç‰‡åŒºåŸŸ --- */
        #floating-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; pointer-events: none; 
        }

        .float-img {
            position: absolute; opacity: 0.9; 
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.5s ease;
            max-width: 200px; max-height: 200px;
            object-fit: cover;
            border: 3px solid #fff; /* ç»™å›¾ç‰‡åŠ ä¸ªç™½è¾¹æ¡†ï¼Œåƒæ‹ç«‹å¾— */
        }

        /* --- å·¦ä¾§æŒ‰é’® --- */
        .sidebar {
            position: fixed; left: 20px; top: 100px;
            display: flex; flex-direction: column; gap: 20px; z-index: 100; 
        }

        .cute-btn {
            background-color: rgba(255, 183, 178, 0.9); /* åŠé€æ˜çº¢ */
            backdrop-filter: blur(5px);
            color: white; border: none; padding: 15px 25px;
            border-radius: 20px; font-size: 16px; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        .cute-btn:hover { transform: scale(1.05); background-color: #ff9e99; }

        /* --- å¼¹çª—æ ·å¼ --- */
        #modal-overlay {
            display: none; position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(3px); /* èƒŒæ™¯æ¨¡ç³Šæ›´é«˜çº§ */
            z-index: 200; justify-content: center; align-items: center;
        }

        .letter-paper {
            background: #fffdf0; width: 85%; max-width: 500px;
            padding: 40px; border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
            max-height: 80vh; overflow-y: auto; /* å†…å®¹å¤ªé•¿å¯æ»šåŠ¨ */
        }

        .letter-content { font-size: 17px; color: #444; min-height: 100px; white-space: pre-wrap; line-height: 1.8; }
        .letter-date { text-align: right; font-size: 13px; color: #888; margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px;}
        
        .letter-controls { margin-top: 20px; display: flex; justify-content: space-between; align-items: center; }
        .ctrl-btn { background: #8ec5fc; border: none; padding: 8px 16px; border-radius: 20px; color: white; cursor: pointer; font-size: 14px;}
        .ctrl-btn:disabled { background: #e0e0e0; cursor: not-allowed; }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; color: #ccc; }

        /* --- å›ä¿¡åŒºåŸŸ --- */
        #reply-area { display: none; margin-top: 20px; background: #fafafa; padding: 15px; border-radius: 8px; }
        #reply-input { width: 100%; height: 80px; border: 1px solid #ddd; border-radius: 4px; padding: 10px; box-sizing: border-box; font-family: inherit; resize: none; }
    </style>
</head>
<body>

    <div id="floating-container"></div>

    <div class="sidebar">
        <button class="cute-btn" onclick="openLetter()">ğŸ•Šï¸ é£é¸½ä¼ ä¿¡</button>
        <button class="cute-btn" onclick="triggerUpload()">ğŸ“· æäº¤å›¾ç‰‡</button>
    </div>

    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
    <input type="file" id="file-input" multiple accept="image/*" style="display: none;" onchange="handleFiles(this.files)">

    <!-- å¼¹çª— -->
    <div id="modal-overlay">
        <div class="letter-paper">
            <div class="close-btn" onclick="closeLetter()">Ã—</div>
            
            <div id="letter-display-area">
                <div class="letter-content" id="content-text">æ­£åœ¨ä»äº‘ç«¯è·å–ä¿¡ä»¶...</div>
                <div class="letter-date" id="content-date">...</div>
            </div>

            <!-- å›ä¿¡è¡¨å• (å…³é”®éƒ¨åˆ†) -->
            <form id="reply-form" onsubmit="handleReplySubmit(event)">
                <div id="reply-area">
                    <p style="font-size: 14px; color: #888; margin:0 0 5px 0;">å›ä¿¡ï¼š</p>
                    <textarea id="reply-input" name="message" placeholder="å†™ä¸‹ä½ æƒ³è¯´çš„è¯...ï¼ˆç‚¹å‡»å‘é€åæˆ‘ä¼šæ”¶åˆ°é‚®ä»¶ï¼‰" required></textarea>
                    <!-- éšè—å­—æ®µï¼Œå‘Šè¯‰ä½ æ˜¯é’ˆå¯¹å“ªå°ä¿¡å›çš„ -->
                    <input type="hidden" id="reply-subject" name="subject" value="æ¥è‡ªç½‘é¡µçš„æ–°å›ä¿¡">
                    <button type="submit" class="ctrl-btn" style="margin-top: 10px; background-color: #ffb7b2; width: 100%;">å‘é€å›ä¿¡</button>
                </div>
            </form>

            <div class="letter-controls">
                <button class="ctrl-btn" id="prev-btn" onclick="changeLetter(-1)">ä¸Šä¸€å°</button>
                <button class="ctrl-btn" style="background-color: #ff9e99;" onclick="toggleReplyBox()">ğŸ’Œ å†™å›ä¿¡</button>
                <button class="ctrl-btn" id="next-btn" onclick="changeLetter(1)">ä¸‹ä¸€å°</button>
            </div>
        </div>
    </div>

    <script>
        // ================= é…ç½®åŒºåŸŸ (è¯·ä¿®æ”¹è¿™é‡Œ!) =================
        const config = {
            githubUsername: 'ajiewudi',      // ä½ çš„ç”¨æˆ·å
            repoName: 'ajiewudi.github.io',  // ä½ çš„ä»“åº“å
            // åœ¨è¿™é‡Œå¡«å…¥ä½ åœ¨ pushplus.plus è·å¾—çš„ Token
            pushPlusToken: '8a3ba3a0fcdb475f8c259e54686a838e'        
        };
        // ========================================================

        let letters = []; // å­˜æ”¾ä¸‹è½½ä¸‹æ¥çš„ä¿¡
        let currentLetterIndex = 0;

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        window.onload = function() {
            loadImages();
            loadLetters();
        };

        // --- 1. è‡ªåŠ¨åŠ è½½å›¾ç‰‡é€»è¾‘ ---
        function loadImages() {
            const apiUrl = `https://api.github.com/repos/${config.githubUsername}/${config.repoName}/contents/images`;
            const container = document.getElementById('floating-container');

            fetch(apiUrl)
            .then(res => res.ok ? res.json() : [])
            .then(data => {
                data.forEach(file => {
                    // æ’é™¤ bg.jpgï¼Œä¸è®©èƒŒæ™¯å›¾ä¹Ÿé£˜èµ·æ¥
                    if (file.name.match(/\.(jpg|jpeg|png|gif)$/i) && file.name !== 'bg.jpg') {
                        createFloatingImage(file.download_url);
                    }
                });
            })
            .catch(err => console.log("å›¾ç‰‡åŠ è½½è·³è¿‡ï¼ˆå¯èƒ½æ˜¯æœ¬åœ°æµ‹è¯•æˆ–æ— æ–‡ä»¶å¤¹ï¼‰"));
        }

        function createFloatingImage(url) {
            const img = document.createElement('img');
            img.src = url;
            img.className = 'float-img';
            document.getElementById('floating-container').appendChild(img);
            img.onload = () => animateElement(img);
        }

        function animateElement(el) {
            const startX = Math.random() * (window.innerWidth - 100);
            const startY = Math.random() * (window.innerHeight - 100);
            el.style.left = startX + 'px'; el.style.top = startY + 'px';
            let vx = (Math.random() - 0.5) * 1; let vy = (Math.random() - 0.5) * 1;

            function move() {
                let rect = el.getBoundingClientRect();
                let x = parseFloat(el.style.left); let y = parseFloat(el.style.top);
                if (rect.left<=0 || rect.right>=window.innerWidth) vx*=-1;
                if (rect.top<=0 || rect.bottom>=window.innerHeight) vy*=-1;
                el.style.left = (x+vx)+'px'; el.style.top = (y+vy)+'px';
                requestAnimationFrame(move);
            }
            move();
        }

        // --- 2. è‡ªåŠ¨è¯»å–ä¿¡ä»¶é€»è¾‘ ---
        async function loadLetters() {
            const apiUrl = `https://api.github.com/repos/${config.githubUsername}/${config.repoName}/contents/letters`;
            
            try {
                const res = await fetch(apiUrl);
                if (!res.ok) throw new Error("æ— æ³•è¯»å– letters æ–‡ä»¶å¤¹");
                const files = await res.json();

                // è¿‡æ»¤å‡º .txt æ–‡ä»¶å¹¶æ’åº
                const txtFiles = files.filter(f => f.name.endsWith('.txt')).sort((a,b) => a.name.localeCompare(b.name));

                // é€ä¸ªè·å–å†…å®¹
                const loadedLetters = [];
                for (const file of txtFiles) {
                    const contentRes = await fetch(file.download_url);
                    const text = await contentRes.text();
                    // è§£æï¼šç¬¬ä¸€è¡Œæ˜¯æ—¥æœŸï¼Œå‰©ä¸‹æ˜¯å†…å®¹
                    const splitIndex = text.indexOf('\n');
                    let dateStr = "æœªçŸ¥æ—¥æœŸ";
                    let bodyStr = text;
                    
                    if (splitIndex !== -1) {
                        dateStr = text.substring(0, splitIndex).trim();
                        bodyStr = text.substring(splitIndex + 1).trim();
                    }

                    loadedLetters.push({ date: dateStr, text: bodyStr, fileName: file.name });
                }

                if (loadedLetters.length > 0) {
                    letters = loadedLetters;
                } else {
                    letters = [{ date: "ç³»ç»Ÿæç¤º", text: "letters æ–‡ä»¶å¤¹é‡Œæ²¡æœ‰ txt æ–‡ä»¶å“¦ã€‚" }];
                }

            } catch (err) {
                console.error(err);
                letters = [{ date: "ç³»ç»Ÿæç¤º", text: "è¿˜æ²¡æœ‰ä¸Šä¼ ä¿¡ä»¶ï¼Œæˆ–è€… letters æ–‡ä»¶å¤¹ä¸å­˜åœ¨ã€‚\n\nè¯·åœ¨ä»“åº“å»ºç«‹ letters æ–‡ä»¶å¤¹å¹¶æ”¾å…¥ 1.txt ç­‰æ–‡ä»¶ã€‚" }];
            }
        }

        // --- 3. äº¤äº’é€»è¾‘ ---
        const modal = document.getElementById('modal-overlay');
        const contentText = document.getElementById('content-text');
        const contentDate = document.getElementById('content-date');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const replyArea = document.getElementById('reply-area');

        function openLetter() {
            modal.style.display = 'flex';
            if (letters.length > 0) renderLetter();
        }
        function closeLetter() { modal.style.display = 'none'; replyArea.style.display = 'none'; }
        


        function renderLetter() {
            const l = letters[currentLetterIndex];
            
            // --- å…³é”®ä¿®æ”¹ï¼šå…ˆè¯»å–åŸæ¥çš„ä¿¡ï¼Œå†çœ‹çœ‹æœ‰æ²¡æœ‰æœ¬åœ°ä¿å­˜çš„å›ä¿¡ ---
            let finalContent = l.text;
            
            // ä½¿ç”¨æ–‡ä»¶åä½œä¸ºå”¯ä¸€æ ‡è¯†ï¼Œé¿å…ä¸åŒä¿¡ä»¶çš„å›ä¿¡ææ··
            const replyKey = 'reply_to_' + l.fileName;
            const mySavedReply = localStorage.getItem(replyKey);

            if (mySavedReply) {
                // å¦‚æœä»–å›è¿‡ä¿¡ï¼Œå°±æ‹¼æ¥åˆ°åé¢æ˜¾ç¤º
                finalContent += `\n\n\nâ”€â”€â”€â”€â”€â”€â”€ ( ä½ çš„å›ä¿¡ ) â”€â”€â”€â”€â”€â”€â”€\n\n${mySavedReply}`;
                
                // å¦‚æœå·²ç»å›è¿‡ä¿¡ï¼Œéšè—è¾“å…¥æ¡†ï¼Œé¿å…é‡å¤å‘é€
                document.getElementById('reply-area').style.display = 'none';
            }
            // ----------------------------------------------------

            contentText.textContent = finalContent;
            contentDate.textContent = l.date;
            
            prevBtn.disabled = currentLetterIndex === 0;
            nextBtn.disabled = currentLetterIndex === letters.length - 1;
        }













        

        function changeLetter(step) {
            currentLetterIndex += step;
            renderLetter();
            replyArea.style.display = 'none'; // æ¢ä¿¡æ—¶æ”¶èµ·å›ä¿¡æ¡†
        }

        function toggleReplyBox() {
            replyArea.style.display = (replyArea.style.display === 'block') ? 'none' : 'block';
        }

        // --- 4. å¤„ç†å›ä¿¡å‘é€ (Formspree) ---
        function handleReplySubmit(e) {
            e.preventDefault(); 
            
            const messageInput = document.getElementById('reply-input');
            const replyText = messageInput.value; // ä»–çš„å›ä¿¡å†…å®¹
            const submitBtn = document.querySelector('#reply-form button[type="submit"]');
            
            // è·å–å½“å‰æ˜¾ç¤ºçš„è¿™å°ä¿¡çš„æ‰€æœ‰ä¿¡æ¯ï¼ˆåŸæ–‡ã€æ—¥æœŸã€æ–‡ä»¶åï¼‰
            const currentLetter = letters[currentLetterIndex]; 
            const originalText = currentLetter.text; // ä¿¡ä»¶åŸæ–‡

            if (!replyText.trim()) {
                alert("å†™ç‚¹ä»€ä¹ˆå†å‘å˜›~ ğŸ¥º");
                return;
            }

            // 1. é”å®šæŒ‰é’®
            submitBtn.disabled = true;
            submitBtn.innerText = "æ­£åœ¨é£å¥”å‘ä½ ...";

            // ----------------------------------------------------
            // âœ¨ æ ¸å¿ƒä¿®æ”¹ï¼šæŠŠåŸæ–‡å’Œå›ä¿¡æ‹¼æ¥åˆ°ä¸€èµ· âœ¨
            // ----------------------------------------------------
            const combinedContent = 
                `ğŸ“… ä¿¡ä»¶æ—¥æœŸï¼š${currentLetter.date}\n` +
                `ğŸ“„ æ–‡ä»¶åï¼š${currentLetter.fileName}\n\n` +
                `ğŸ“ ã€ä¿¡ä»¶åŸæ–‡ã€‘ï¼š\n${originalText}\n\n` +
                `------------------------------------\n` +
                `ğŸ’Œ ã€TAçš„å›ä¿¡ã€‘ï¼š\n${replyText}`;

            // 2. å‡†å¤‡å‘é€ç»™ PushPlus çš„æ•°æ®
            const pushData = {
                token: config.pushPlusToken,
                title: `ğŸ’Œ æ”¶åˆ°æ–°çš„å›ä¿¡ï¼æ¥è‡ª [${currentLetter.date}]`,
                content: combinedContent, // è¿™é‡Œå‘é€æ‹¼æ¥å¥½çš„å®Œæ•´å†…å®¹
                template: 'txt' 
            };

            // 3. å‘é€è¯·æ±‚ (PushPlus)
            fetch('http://www.pushplus.plus/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(pushData)
            })
            .then(response => response.json())
            .then(data => {
                // 4. å‘é€æˆåŠŸåçš„å¤„ç†ï¼ˆè§†è§‰æ•ˆæœï¼šä¿®æ”¹ç½‘é¡µæ˜¾ç¤ºï¼‰
                
                // A. ä¿å­˜å›ä¿¡åˆ°æœ¬åœ°ï¼ˆåªä¿å­˜å›ä¿¡éƒ¨åˆ†å³å¯ï¼Œå› ä¸ºåŸæ–‡æˆ‘ä»¬æœ¬æ¥å°±æœ‰ï¼‰
                const replyKey = 'reply_to_' + currentLetter.fileName;
                localStorage.setItem(replyKey, replyText);

                // B. åˆ·æ–°ç•Œé¢ï¼Œè®©ä»–ç«‹åˆ»çœ‹åˆ°ä¿¡åé¢å¤šäº†ä»–çš„è¯
                renderLetter();

                alert("æ”¶åˆ°å•¦ï¼ä½ çš„å›ä¿¡å·²ç»å’Œæˆ‘çš„ä¿¡èä¸ºä¸€ä½“äº† â¤ï¸\n(æˆ‘ä¹Ÿåœ¨å¾®ä¿¡ä¸Šæ”¶åˆ°æé†’å•¦)");
            })
            .catch(error => {
                console.error('å‘é€å¤±è´¥:', error);
                // å³ä½¿æ–­ç½‘ï¼Œä¹Ÿè¦æ¨¡æ‹ŸæˆåŠŸ
                const replyKey = 'reply_to_' + currentLetter.fileName;
                localStorage.setItem(replyKey, replyText);
                renderLetter();
                alert("è™½ç„¶ç½‘ç»œæœ‰ç‚¹å°æ³¢åŠ¨ï¼Œä½†å›ä¿¡æˆ‘å·²ç»è®°ä¸‹äº†ï¼");
            })
            .finally(() => {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                submitBtn.disabled = false;
                submitBtn.innerText = "å‘é€å›ä¿¡";
                messageInput.value = ""; 
            });
        }














        

        // ä¸´æ—¶ä¸Šä¼ åŠŸèƒ½
        function triggerUpload() { document.getElementById('file-input').click(); }
        function handleFiles(files) {
            if(!files.length) return;
            for(let i=0; i<files.length; i++){
                let reader = new FileReader();
                reader.onload = e => createFloatingImage(e.target.result);
                reader.readAsDataURL(files[i]);
            }
        }
    </script>
</body>
</html>
